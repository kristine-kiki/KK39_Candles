{% extends 'base.html' %}
{% load static %}

{% block title %}
    KK39 Candles - Your Shopping Bag
{% endblock title %}

{% block content %}

<div class="container">
    <h1>Your Shopping Bag</h1>

    {# Check if there are items in the bag using the context #}
    {% if bag_items %}
        <div class="bag-page-content" id="bag-with-items">

            <div class="bag-items">
                <h2>Items ({{ product_count }})</h2>
                <div class="bag-items-list" id="bag-items-list">

                    {# Loop through items provided by bag_contents context #}
                    {% for item in bag_items %}
                    <div class="bag-item"> {# Removed data-product-id as we might handle removal differently #}
                        <div class="bag-item-img">
                            {# Assuming your Product model has an ImageField named 'image' #}
                            {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <img src="{% static 'images/default_product.png' %}" alt="{{ item.product.name }}"> {# Placeholder image #}
                            {% endif %}
                        </div>
                        <div class="bag-item-details">
                            <h3>{{ item.product.name }}</h3>
                            {# Display size only if it exists for this item in the bag #}
                            {% if item.size %}
                                <p>Size: {{ item.size|upper }}</p> {# Or however you store/display size #}
                            {% endif %}
                            {# You might want to display other product details here #}
                            {# {% if item.product.scent %}
                                <p>Scent: {{ item.product.scent }}</p>
                            {% endif %} #}
                            <p>Price: ${{ item.product.price|floatformat:2 }}</p>

                            {# --- Quantity and Remove Handling --- #}
                            {# This part requires forms submitting to Django views #}
                            {# Form for updating quantity #}
                            <form class="form update-form" method="POST" action="{% url 'adjust_bag' item.item_id %}">
                                {% csrf_token %}
                                <div class="item-quantity">
                                     <label for="quantity_{{ item.item_id }}{% if item.size %}_{{ item.size }}{% endif %}">Qty:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <button class="quantity-decrease btn btn-sm btn-outline-secondary rounded-0" type="button" data-item_id="{{ item.item_id }}" data-size="{{ item.size|default:'' }}" aria-label="Decrease quantity">-</button>
                                        </div>
                                        {# The name attribute is crucial for the view to get the quantity #}
                                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99" {# Max based on your stock logic #}
                                               id="quantity_{{ item.item_id }}{% if item.size %}_{{ item.size }}{% endif %}"
                                               class="item-quantity-input form-control form-control-sm text-center"
                                               data-item_id="{{ item.item_id }}" data-size="{{ item.size|default:'' }}"
                                               aria-label="Quantity">
                                         <div class="input-group-append">
                                            <button class="quantity-increase btn btn-sm btn-outline-secondary rounded-0" type="button" data-item_id="{{ item.item_id }}" data-size="{{ item.size|default:'' }}" aria-label="Increase quantity">+</button>
                                        </div>
                                        {# Optional: Add size as hidden input if your adjust_bag view needs it #}
                                        {% if item.size %}
                                            <input type="hidden" name="product_size" value="{{ item.size }}">
                                        {% endif %}
                                        {# Implicitly submits on change via JS, or add an Update button #}
                                        {# Or use JS below to handle +/- button clicks #}
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="item-actions">
                             {# Calculate line price: item quantity * item price #}
                             {# We need to add line_total to the context OR use a template tag #}
                             {# Assuming you added line_total in contexts.py (Recommended) #}
                            <p class="item-line-price">${{ item.line_total|floatformat:2 }}</p>
                            {# Form for removing item #}
                             <form class="form remove-form" method="POST" action="{% url 'remove_from_bag' item.item_id %}">
                                {% csrf_token %}
                                {% if item.size %}
                                    <input type="hidden" name="product_size" value="{{ item.size }}">
                                {% endif %}
                                <button type="submit" class="remove-item-btn btn btn-link text-danger">Remove</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bag-summary">
                <h2>Order Summary</h2>
                <p>
                    <span>Subtotal:</span>
                    {# Display total from context, formatted as currency #}
                    <span id="bag-subtotal">${{ total|floatformat:2 }}</span>
                </p>

                {# Display delivery info from context #}
                <p>
                    <span>Delivery:</span>
                    {% if delivery > 0 %}
                        <span id="bag-shipping">${{ delivery|floatformat:2 }}</span>
                    {% else %}
                         <span id="bag-shipping">FREE</span>
                    {% endif %}
                </p>

                {# Optional: Display message about free delivery #}
                {% if free_delivery_delta > 0 %}
                    <p class="text-muted">Add ${{ free_delivery_delta|floatformat:2 }} more for free delivery!</p>
                {% endif %}

                <p class="total">
                    <span>Grand Total:</span>
                    {# Display grand_total from context #}
                    <span id="bag-total">${{ grand_total|floatformat:2 }}</span>
                </p>

                {# Use Django url tag for checkout link #}
                <a href="{% url 'checkout' %}" class="button button-primary checkout-button">Proceed to Checkout</a>

                {# Use Django url tag for continue shopping link #}
                <a href="{% url 'products' %}" class="continue-shopping-link">Continue Shopping</a> {# Adjust 'products' to your products list view name #}
            </div>

        </div>

    {% else %}
        {# This section shows when the bag is empty #}
        <div class="empty-bag-message" id="empty-bag-message">
            <h2>Your Bag is Empty</h2>
            <p>Looks like you haven't added any candles yet!</p>
            <a href="{% url 'products' %}" class="button button-secondary">Start Shopping</a> {# Adjust 'products' #}
        </div>
    {% endif %}

</div><!-- /.container -->

{# Remove or keep this script depending on whether you need JS for UI interactions #}
{# like the +/- buttons, but NOT for loading data or calculating totals #}
{# <script src="{% static 'js/bag.js' %}" defer></script> #}

{# --- Optional: Add basic JavaScript for quantity buttons --- #}
{# This JS does NOT load data, just helps submit the update form #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Handle quantity decrease button clicks
    document.querySelectorAll('.quantity-decrease').forEach(button => {
        button.addEventListener('click', e => {
            const input = e.target.closest('.input-group').querySelector('.item-quantity-input');
            let currentValue = parseInt(input.value);
            if (currentValue > input.min) {
                input.value = currentValue - 1;
                // Submit the form associated with this button/input
                input.closest('form').submit();
            }
        });
    });

    // Handle quantity increase button clicks
    document.querySelectorAll('.quantity-increase').forEach(button => {
        button.addEventListener('click', e => {
            const input = e.target.closest('.input-group').querySelector('.item-quantity-input');
             let currentValue = parseInt(input.value);
             // Check against max attribute if needed
             if (input.max === "" || currentValue < input.max) {
                input.value = currentValue + 1;
                 // Submit the form associated with this button/input
                 input.closest('form').submit();
             }
        });
    });

    // Optional: Handle direct input change (e.g., typing a number)
    // Debounce this if you expect users to type quickly
    document.querySelectorAll('.item-quantity-input').forEach(input => {
        let debounceTimeout;
        input.addEventListener('change', e => {
            // Clear any existing timeout
            clearTimeout(debounceTimeout);
            // Set a new timeout to submit the form after a short delay (e.g., 750ms)
            debounceTimeout = setTimeout(() => {
                // Ensure value is within min/max before submitting
                let value = parseInt(input.value);
                const min = parseInt(input.min);
                const max = parseInt(input.max);
                 if (isNaN(value) || value < min) {
                     input.value = min; // Correct invalid input visually
                 } else if (!isNaN(max) && value > max) {
                     input.value = max; // Correct invalid input visually
                 }
                 // Submit the form
                 input.closest('form').submit();
            }, 750); // Adjust delay as needed
        });
    });
});
</script>

{% endblock content %}